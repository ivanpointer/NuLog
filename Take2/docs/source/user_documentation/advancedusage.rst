.. rst-class:: center

.. image:: sitetitle.png

----

################
  Advanced Usage
################

Shutting Down NuLog
===================

Standard method
---------------

**Please note that NuLog has implemented finalizers, so that shutting down NuLog is not necessary.  Your log messages will be flushed, and NuLog will exit cleanly automatically, on application exit.**  However, if for any reason you want to shut NuLog down before application exit, the most standard way to do this is using the `Shutdown` method
of the `LogManager`.  You would do this if you are using the `LogManager` to manage your logging construction needs:

.. literalinclude:: /../../NuLogSnippets/Docs/ShutdownLogManager.cs
   :lines: 11-18
   :tab-width: 4
   :dedent: 2
   :linenos:

StandardLoggerFactory Finalizer
-------------------------------
The standard logger factory implementation has a finalizer, which disposes the assets managed by the factory, namely, the `IDispatcher` assigned to it, when garbage collection deconstructs it.

Disposing the Dispatcher
------------------------
It is important to dispose the dispatcher, so that the queued log events can be sent to their targets before application exit.  `Again, this isn't necessary, as the finalizers will automatically do this for you on application exit.`

Like the `StandardLoggerFactory` the `StandardDispatcher` also has a finalizer, which will dispose the dispatcher when disposed of by the garbage
collector.

Meta Data Providers
===================
Much like static meta data, dynamic meta data can be included in log events to be delivered to the targets.  To do this, a `IMetaDataProvider`
instance must be passed to the log manager when requesting a logger.

Custom Meta Data Provider
-------------------------

The `IMetaDataProvider` interface has a single method for providing meta data:

.. literalinclude:: /../../NuLog/Loggers/IMetaDataProvider.cs
   :lines: 9-18
   :emphasize-lines: 9
   :linenos:

There's not any more to it than that.  As an illustration, however, let's take a look at an implementation that includes some request data for a MVC controller:

.. literalinclude:: /../../NuLogSnippets/Docs/MyControllerMetaDataProvider.cs
   :lines: 11-29
   :emphasize-lines: 10-18
   :linenos:

This meta data provider will include information specific to the request, for the given controller.  Next, let's take a look at how to use our new meta data provider.

Using Meta Data Providers
-------------------------


To use our custom meta data provider, we pass an instance of it to our log manager when requesting a logger:

.. literalinclude:: /../../NuLogSnippets/Docs/MyMetaDataProviderController.cs
   :lines: 10-25
   :emphasize-lines: 7-8,13
   :linenos:


Advanced Rule Routing
=====================

The 'final' and 'strictInclude' Flags
-------------------------------------

Complex routing can be achieved using the `final` and `strictInclude` flags:

* **final** - When set to `true`, and if a log message matches the rule, no further rules will be processed.  Rules are processed in consecutive order, as listed in the rule list.
* **strictInclude** - By default, if any tag is matched in the `include` list, the rule is matched.  By seting the `StrictInclude` flag, all tags (or tag patterns) listed in `include` must match for the rule to be considered a match.

Examples
--------

**final**

Let's say that you want to send messages with the "consoleonly" tag, only to console, but have a general, catch-all rule in place.  In the following example, events with the `consoleonly` tag will be routed only to the console target, all others will only go to the file target:

.. literalinclude:: /../../NuLogSnippets/ConsoleOnlyRule.config
   :language: xml
   :lines: 8-16
   :tab-width: 4
   :dedent: 2
   :linenos:

**strictInclude**

We use the `strictInclude` flag to state that all tags/patterns in the "include" of the rule must be matched for the rule to match.  This enables us
to zero in on specific log events:

.. literalinclude:: /../../NuLogSnippets/StrictIncludeRule.config
   :language: xml
   :lines: 8-13
   :tab-width: 4
   :dedent: 2
   :linenos:

The above rule states that all log events with the `index` tag, and a tag starting with `NuLogSnippets.` are routed to the target named `file`.  Note that the class that log events
are logged from are automatically added as tags, for example: `NuLogSnippets.Docs.MyMetaDataProviderController` is added to the log events generated by the `Index` action,
and any other calls to the logger, in that class.